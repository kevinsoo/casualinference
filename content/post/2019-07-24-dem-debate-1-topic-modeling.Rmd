---
title: 'Dem Debate 1: Topic modeling'
author: Kevin soo
date: '2019-07-24'
slug: dem-debate-1-topic-modeling
categories:
  - R
tags:
  - text analysis
  - politics
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load libraries
library(tidyverse)
library(tidytext)
library(widyr)
library(tidyr)
library(topicmodels)
library(cowplot)
library(cluster)
library(factoextra) # clustering visualization
library(dendextend)
library(ggdendro)

# Load data
load(file = "files/dem-debate-1-topic-modeling/demDebate1_LDA_k4.Rda")
load(file = "files/dem-debate-1-topic-modeling/demDebate1_topicProbs.Rda")
```

The second Democratic debate is almost here, so I wanted to follow up the [sentiment analysis](https://casualinference.netlify.com/2019/07/02/dem-debate-1-sentiment-analysis/) I performed on the first debate by looking at the topics that were talked about across the two nights.

In [natural language processing](https://en.wikipedia.org/wiki/Natural_language_processing), a [topic model](http://journalofdigitalhumanities.org/2-1/topic-modeling-a-basic-introduction-by-megan-r-brett/) is a statistical model that can be used to infer the underlying meanings (i.e. *topics*) of utterances based on the words being used. In this post, I use [Latent Dirichlet Allocation](https://en.wikipedia.org/wiki/Latent_Dirichlet_allocation) (LDA) from the `topicmodels` package to infer what each speech by the candidates is about. The model assumes:

1. **Every speech is about a mixture of topics.** For example, in a reply to a question by a moderator, a candidate might be speaking about the economy, or about the economy *and* climate change, etc. In contrast to other classification methods that try to identify only a single underlying category, LDA assigns probabilities to each topic, indicating the probability that a speech is about that topic.

2. **Each topic of interest is spoken about using a reliable collection of words.** For example, when speaking about a topic like healthcare, a candidate may use words like "insurance" and "medicare". If we assume that an underlying topic generates certain words, each topic can be described as a collection of frequently co-occurring words.

## Identifying topics

Determining the number of topics (*k*) that are talked about within a corpus (i.e. all speeches during the two nights of the first Democratic debate) is a tricky endeavour. There are various approaches to determining the optimal *k* (e.g., [Griffiths & Steyvers, 2004](http://doi.org/10.1073/pnas.0307752101); [Arun et al., 2010](https://link.springer.com/chapter/10.1007%2F978-3-642-13657-3_43)), but these methods do not always converge. A more practical issue is that the optimal *k* computed via such methods may not be semantically meaningful. 

For this post, I went with *k* = 4, because it led to semantically interpretable topics.[^1] The following figure displays the four topics the model identified in the transcripts of the first Democratic debate. Within each topic, the figure plots the beta weights of the top eight terms.[^2] Beta represents the probability of a term being generated by that topic. I believe the terms in each topic make the labels pretty self-explanatory.

```{r topics, echo=FALSE, message=FALSE, warning=FALSE}
# Rearrange LDA data
ldaTidy <- tidy(lda)

# Clean data, removing common words
topTerms <- ldaTidy %>%
      filter(!term %in% c("president", "america", "american", "country", "people", "united", "states")) %>%
      group_by(topic) %>%
      top_n(8, beta) %>%
      ungroup() %>%
      arrange(topic, beta) %>% 
      mutate(order = row_number())

# Plot most common terms in topic
topTerms %>%
      mutate(topic = ifelse(topic == 1, "Future generations",
                            ifelse(topic == 2, "Healthcare",
                                   ifelse(topic == 3, "International affairs", "Economy")))) %>% 
      ggplot(aes(x = order, y = beta, fill = factor(topic))) +
      geom_col(show.legend = FALSE) +
      facet_wrap(~ topic, scales = "free") +
      scale_x_continuous(breaks = topTerms$order, labels = topTerms$term, minor_breaks = NULL) +
      scale_fill_viridis_d() +
      coord_flip() +
      theme_minimal() +
      labs(title = "Top terms by topic at the Dem Debates (June 2019)", 
           x = "Terms", y = "Beta")

```

While the four topics -- *Economy*, *Future generations*, *Healthcare*, and *International affairs* -- are certainly not exhaustive, I believe they can be useful as broad categories for looking at patterns in what the debates were about.

## Topics over time

After identifying the topics of interest, we can look at the inferences the model makes about each speech. For example, when Pete Buttigieg speaks at a particular juncture, what topic does the model infer as being the most probable? In the following figures, I display each topic's gamma values for every speech (separately for the first and second nights of the debate). Gamma represents the probability of a speech being about a particular topic (gammas for all four topics sum to 1).

The speeches are arranged chronologically, painting a picture of how the topics being discussed changed over the course of each debate. In the first row, I have visualized the gamma values for each speech using bars, to illustrate the most salient topics at each point in time (note the changes in color). In the second row, I visualized the gamma values using points, and included trend lines to show how the the salience of each topic changed over time.

```{r topicsTime, echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=8}
# Plot topics over time
b <- df %>% 
      ggplot(aes(x = ID_overall, y = gamma)) +
      facet_grid(~ Debate, scales = "free") +
      geom_point(aes(color = topic), alpha = .20) +
      stat_smooth(aes(color = topic), alpha = .2) +
      scale_y_continuous(limits = c(-.10, 1)) +
      scale_x_continuous(breaks = NULL) +
      scale_color_viridis_d(name = "Topic") +
      theme_minimal() +
      labs(y = "Gamma", x = "Time")
a <- df %>% 
      ungroup() %>% 
      ggplot(aes(x = ID_overall, y = gamma)) +
      facet_grid(~ Debate, scales = "free") +
      geom_col(aes(fill = topic), width = 1) +
      scale_x_continuous(breaks = NULL) +
      scale_fill_viridis_d(name = "Topic") +
      theme_minimal() +
      labs(y = "Gamma", x = NULL,
           title = "Topic probabilities of speeches at the Dem Debates")
legend <- get_legend(a)
plot_grid(
      plot_grid(a + theme(legend.position = "none"), b + theme(legend.position = "none"), nrow = 2),
      legend,
      ncol = 2, rel_widths = c(.5, .1))
```

From these plots, it's clear that on both nights, candidates started by talking about the economy (and to a lesser extent, healthcare). Around the quarter-mark, candidates started talking about issues faced by future generations (gun control, climate change, etc.). There were also differences; on the first night, candidates shifted to talking about international affairs towards the end of the debate, while on the second night this occured around the midpoint.

## Topics by candidate

Finally, I wanted to see if candidates differed in the topics they tended to focus on in their speeches. To do this, I computed the average gamma within each topic for each candidate (higher average gammas indicate a candidate's speeches were more likely to be about a particular topic). This results in candidate profiles of the relative importance of each topic.

Before displaying these profiles, I wanted to categorize candidates based on their similarity to aid interpretation. To do this, I used [hierarchical clustering](https://uc-r.github.io/hc_clustering) (from the `cluster` package) to identify groups of candidates based on the pattern of their average gamma for the various topics. This clustering method identifies these groups based on the similarities between candidates, which I visualized in the following dendrogram. Based on the relative importance of each topic in their speeches, there are four groups of candidates.

```{r dendro, echo=FALSE, message=FALSE, warning=FALSE, fig.height=4}
# Get data and clean
cluster <- df %>%
      group_by(Speaker, topic) %>% 
      summarise(M = mean(gamma)) %>% 
      spread(topic, M) %>% 
      rename(FutureGenerations = `Future generations`,
             InternationalAffairs = `International affairs`)
cluster <- as.data.frame(cluster)
row.names(cluster) <- cluster$Speaker

# Dissimilarity matrix
d <- dist(cluster, method = "euclidean")

# Hierarchical clustering using Complete Linkage
hc1 <- hclust(d, method = "complete" )

# Create dendrogram
dend <- dendro_data(hc1)

# Get groups
labs <- label(dend)
labs$group <- as.factor(c("A", rep("B", 9), rep("C", 4), rep("D", 6)))

# Plot
ggplot(segment(dend)) +
      geom_segment(aes(x = x, y = y, xend = xend, yend = yend)) +
      ylim(c(-.4, 1.1)) +
      geom_text(data=label(dend), 
                aes(label = label, x = x, y = y, color = labs$group), 
                angle=90, hjust=1.15, size=4, show.legend = FALSE) +
      geom_point(data=label(dend), aes(x=x, y=y, colour=labs$group), size=2) +
      theme_minimal() + 
      theme_dendro() + 
      theme(legend.position = "none") +
      scale_color_viridis_d() +
      labs(title= "Candidates grouped by average topic probabilities")
```

#### Economy-plus candidate

First comes Andrew Yang in a class of his own. He only made seven speeches, but focused very heavily on the economy relative to other topics.

```{r groupA, echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width=3}
# Plot
df %>%
      mutate(Cluster = ifelse(Speaker == "Yang", "A",
                              ifelse(Speaker %in% c("Inslee", "Warren", "Bennet", "Delaney"), "C",
                                     ifelse(Speaker %in% c("Hickenlooper", "Klobuchar", "Buttigieg", "Harris", "Biden", "Ryan"), "D", "B")))) %>% 
      mutate(Speaker = factor(Speaker, levels = labs$label)) %>% 
      group_by(Speaker, Cluster, topic) %>% 
      summarise(N = n(), M = mean(gamma), SD = sd(gamma), SE = SD/sqrt(N)) %>% 
      filter(Cluster == "A") %>% 
      ggplot(aes(x = topic, y = M)) +
      geom_path(aes(group = Speaker)) +
      geom_point(aes(color = topic), size = 4) +
      facet_wrap(~ Speaker) +
      theme_minimal() +
      scale_color_viridis_d() +
      theme(legend.position = "none", axis.text.x = element_text(angle = 60, vjust = .5)) +
      labs(x = NULL, y = "Average gamma")
```

#### Healthcare-now candidates

The following four candidates have topic distributions that favor healthcare over talking about issues facing future generations. 

```{r groupC, echo=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=6}
# Plot
df %>%
      mutate(Cluster = ifelse(Speaker == "Yang", "A",
                              ifelse(Speaker %in% c("Inslee", "Warren", "Bennet", "Delaney"), "C",
                                     ifelse(Speaker %in% c("Hickenlooper", "Klobuchar", "Buttigieg", "Harris", "Biden", "Ryan"), "D", "B")))) %>% 
      mutate(Speaker = factor(Speaker, levels = labs$label)) %>% 
      group_by(Speaker, Cluster, topic) %>% 
      summarise(N = n(), M = mean(gamma), SD = sd(gamma), SE = SD/sqrt(N)) %>% 
      filter(Cluster == "C") %>% 
      ggplot(aes(x = topic, y = M)) +
      geom_path(aes(group = Speaker)) +
      geom_point(aes(color = topic), size = 4) +
      facet_wrap(~ Speaker) +
      theme_minimal() +
      scale_color_viridis_d() +
      theme(legend.position = "none", axis.text.x = element_text(angle = 60, vjust = .5)) +
      labs(x = NULL, y = "Average gamma")
```

#### Worldly candidates

These six candidates seemed to focus just a bit more on international affairs than other topics.

```{r groupD, echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=9}
# Plot
df %>%
      mutate(Cluster = ifelse(Speaker == "Yang", "A",
                              ifelse(Speaker %in% c("Inslee", "Warren", "Bennet", "Delaney"), "C",
                                     ifelse(Speaker %in% c("Hickenlooper", "Klobuchar", "Buttigieg", "Harris", "Biden", "Ryan"), "D", "B")))) %>% 
      mutate(Speaker = factor(Speaker, levels = labs$label)) %>% 
      group_by(Speaker, Cluster, topic) %>% 
      summarise(N = n(), M = mean(gamma), SD = sd(gamma), SE = SD/sqrt(N)) %>% 
      filter(Cluster == "D") %>% 
      ggplot(aes(x = topic, y = M)) +
      geom_path(aes(group = Speaker)) +
      geom_point(aes(color = topic), size = 4) +
      facet_wrap(~ Speaker) +
      theme_minimal() +
      scale_color_viridis_d() +
      theme(legend.position = "none", axis.text.x = element_text(angle = 60, vjust = .5)) +
      labs(x = NULL, y = "Average gamma")
```

#### Scattered candidates

It's hard to succintly describe the patterns of the remaining nine candidates. I couldn't help notice that Cory Booker's topic distribution is eerily similar to Marianne Williamson. They might want to do more to differentiate themselves.

```{r groupB, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=9}
# Plot
df %>%
      mutate(Cluster = ifelse(Speaker == "Yang", "A",
                              ifelse(Speaker %in% c("Inslee", "Warren", "Bennet", "Delaney"), "C",
                                     ifelse(Speaker %in% c("Hickenlooper", "Klobuchar", "Buttigieg", "Harris", "Biden", "Ryan"), "D", "B")))) %>% 
      mutate(Speaker = factor(Speaker, levels = labs$label)) %>% 
      group_by(Speaker, Cluster, topic) %>% 
      summarise(N = n(), M = mean(gamma), SD = sd(gamma), SE = SD/sqrt(N)) %>% 
      filter(Cluster == "B") %>% 
      ggplot(aes(x = topic, y = M)) +
      geom_path(aes(group = Speaker)) +
      geom_point(aes(color = topic), size = 4) +
      facet_wrap(~ Speaker) +
      theme_minimal() +
      scale_color_viridis_d() +
      theme(legend.position = "none", axis.text.x = element_text(angle = 60, vjust = .5)) +
      labs(x = NULL, y = "Average gamma")
```

## Conclusion

Natural language processing is complex. While using a model to infer topics from speech helps in understanding broad patterns and trends, no list of topics will fully capture the topics that were actually being spoken about. While the LDA model used here assumes that each topic is identifiable based on particular terms, different candidates may use terms in different ways. 

Furthermore, when considering the topics different candidates tend to focus on, it's worth noting that the topics they address are influenced by moderators and the speeches of other candidates that came before. While the plots above reveal the topics each candidate focused on during the last debate, this does not necessarily correspond to the importance the candidate places on that topic.

Despite these limitations, I believe that such analyses are useful for gaining a general picture of the topics candidates were focusing on in their speeches.

[^1]: [Evelyn Yarzebinski](http://eyarzebinski.com) found this approach lacking, so I used the `ldatuning` package to [evaluate the optimal *k*](https://cran.r-project.org/web/packages/ldatuning/vignettes/topics.html). However, this led to an optimal *k* of 9 or 10, resulting in topics with terms that were hard to meaningfully discern. I didn't want to sacrifice interpretability, hence my decision to stick with *k* = 4.
[^2]: I excluded stopwords ("the", "and", "a"...) and non-diagnostic words that were associated with multiple topics ("president", "america", "country", "people", and "united states").